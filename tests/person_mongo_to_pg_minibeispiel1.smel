-- SMEL Mini-Example: MongoDB -> PostgreSQL
-- Person Document (nested address + tags array + knows reference array) -> 4 Normalized Tables
-- Direction: Denormalized (Embedded) -> Normalized (3NF)

MIGRATION person_mongo_to_pg:1.0
FROM DOCUMENT TO RELATIONAL
USING person_schema:1

-- ============================================
-- Source: MongoDB Person Document
-- ============================================
-- {
--   _id: "p001",
--   name: "Zhang San",
--   address: {
--     street: "Hauptstrasse 10",
--     city: "Berlin"
--   },
--   tags: ["student", "developer"],
--   knows: ["p002", "p003"]
-- }

-- ============================================
-- Target: PostgreSQL 3NF Tables
-- ============================================
-- person (id, name)                           -- id: VARCHAR (from MongoDB _id)
-- address (id, street, city, person_id)       -- id: VARCHAR with prefix "addr" (addr001, addr002...)
-- person_tag (id, tag_value, person_id)       -- id: VARCHAR with prefix "t", 'value' renamed to 'tag_value'
-- person_knows (person_id, knows_person_id)   -- Composite PK (M:N self-reference)

-- ============================================
-- Step 1: FLATTEN nested object -> independent table
-- ============================================
-- Extracts embedded 'address' document into separate 'address' table
-- Generates string ID with "addr" prefix (addr001, addr002...)
-- Adds foreign key 'person_id' referencing person table

FLATTEN person.address AS address
    GENERATE KEY id AS String PREFIX "addr"
    ADD REFERENCE person_id TO person

-- ============================================
-- Step 2: FLATTEN value array -> independent table
-- ============================================
-- Expands 'tags' value array into separate 'person_tag' table
-- Each array element becomes a row with string ID prefix "t" (t001, t002...)
-- Default 'value' column renamed to 'tag_value' via RENAME clause (soft, not hardcoded)

FLATTEN person.tags[] AS person_tag
    GENERATE KEY id AS String PREFIX "t"
    ADD REFERENCE person_id TO person
    RENAME value TO tag_value

-- ============================================
-- Step 3: FLATTEN reference array -> M:N join table
-- ============================================
-- Expands 'knows' reference array into 'person_knows' join table
-- No GENERATE KEY -> composite primary key (person_id, knows_person_id)
-- Both columns are foreign keys referencing person table

FLATTEN person.knows[] AS person_knows
    ADD REFERENCE person_id TO person
    ADD REFERENCE knows_person_id TO person

-- ============================================
-- Step 4: RENAME _id -> id (PostgreSQL naming convention)
-- ============================================

RENAME _id TO id IN person
